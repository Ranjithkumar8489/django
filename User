# views.py

from django.shortcuts import redirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from .threads import ResultThread
from .bot import run_bot_continuously

user_bots = {}

@login_required
def start_bot_view(request):
    user = request.user

    if user.username in user_bots and user_bots[user.username]["running"]:
        messages.error(request, "Bot already running.")
        return redirect('some_view_name')  # Replace 'some_view_name' with the name of your view

    symbol = "TRX/USDT"
    amount = 500.0
    exchanges = ["binance", "kucoin", "kraken"]
    interval = 60  # Run the bot every 60 seconds

    bot_thread = ResultThread(target=run_bot_continuously, args=(symbol, amount, exchanges, interval))
    bot_thread.start()

    user_bots[user.username] = {
        "thread": bot_thread,
        "running": True
    }

    messages.success(request, "Bot started.")
    return redirect('some_view_name')  # Replace 'some_view_name' with the name of your view

@login_required
def stop_bot_view(request):
    user = request.user

    if user.username not in user_bots or not user_bots[user.username]["running"]:
        messages.error(request, "Bot is not running.")
        return redirect('some_view_name')  # Replace 'some_view_name' with the name of your view

    bot_info = user_bots[user.username]
    bot_info["running"] = False
    bot_thread = bot_info["thread"]
    if bot_thread:
        bot_thread.join()
        result = bot_thread.get_result()
        del user_bots[user.username]
        messages.success(request, f"Bot stopped. Result: {result}")
        return redirect('some_view_name')  # Replace 'some_view_name' with the name of your view

    messages.success(request, "Bot stopped.")
    return redirect('some_view_name')  # Replace 'some_view_name' with the name of your view
